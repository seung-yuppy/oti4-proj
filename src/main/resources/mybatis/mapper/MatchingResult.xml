<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.example.bughunters.dao.MatchingResultDAO">

	<!-- 유저가 퀴즈를 했는지 확인 -->
	<select id="selectIsQuizByUserId" parameterType="long"
		resultType="int">
		SELECT is_quiz
		FROM "User"
		WHERE user_id = #{userId}
	</select>

	<!-- 결과 조회 -->
	<select id="selectResultByUserId" parameterType="long"
		resultType="edu.example.bughunters.domain.MatchingResultDTO">
		SELECT
		user_id,
		activity_score,
		sociability_score,
		dependency_score,
		trainability_score,
		aggression_score,
		quiz_count as countNum
		FROM Matching_Abandoned_Pet_And_User
		WHERE user_id = #{userId}
	</select>

	<!-- 첫 저장  -->
	<insert id="insertResult"
		parameterType="edu.example.bughunters.domain.MatchingResultDTO">
		INSERT INTO Matching_Abandoned_Pet_And_User (
		activity_score, sociability_score, dependency_score,
		trainability_score, aggression_score, user_id, quiz_count
		) VALUES (
		ROUND(#{activityScore}, 2),
		ROUND(#{sociabilityScore}, 2),
		ROUND(#{dependencyScore}, 2),
		ROUND(#{trainabilityScore}, 2),
		ROUND(#{aggressionScore}, 2),
		#{userId},
		NVL(#{countNum},1)
		)
	</insert>

	<!-- 퀴즈 2회차 이후 평균 계산된 값으로 업데이트 -->
	<update id="updateResultByUserId"
		parameterType="edu.example.bughunters.domain.MatchingResultDTO">
		UPDATE Matching_Abandoned_Pet_And_User
		SET activity_score = ROUND(#{activityScore}, 2),
		sociability_score = ROUND(#{sociabilityScore}, 2),
		dependency_score = ROUND(#{dependencyScore}, 2),
		trainability_score = ROUND(#{trainabilityScore}, 2),
		aggression_score = ROUND(#{aggressionScore}, 2),
		quiz_count = #{countNum}
		WHERE user_id = #{userId}
	</update>

	<!-- 퀴즈 후 is_quiz=1로 변경 -->
	<update id="setIsQuizTrue" parameterType="long">
		UPDATE "User"
		SET is_quiz = 1
		WHERE user_id = #{userId}
	</update>

	<!-- 강아지 가중치 전부 가져오기 -->
	<select id="selectAllPetWeights"
		resultType="edu.example.bughunters.domain.PetWeightDTO">
		SELECT
		abandoned_pet_id,
		activity_weight,
		sociability_weight,
		dependency_weight,
		trainability_weight,
		aggression_weight,
		description
		FROM Abandoned_Pet_Weight
		WHERE abandoned_pet_id IS NOT NULL
	</select>

	<!-- 상위4마리 강아지 초기화/삽입/조회 -->
	<delete id="deleteTopMatchesByUserId" parameterType="long">
		DELETE FROM Matching_User_Top_Pets
		WHERE user_id = #{userId}
	</delete>

	<insert id="insertTopMatch">
		INSERT INTO Matching_User_Top_Pets(user_id, rank_no, abandoned_pet_id)
		VALUES (#{userId}, #{rankNo}, #{petId})
	</insert>

	<select id="selectTopPetIdsByUserId" parameterType="long"
		resultType="long">
		SELECT abandoned_pet_id
		FROM Matching_User_Top_Pets
		WHERE user_id = #{userId}
		ORDER BY rank_no ASC
	</select>

	<!-- 결과 카드에 필요한 컬럼만 뽑기 -->
	<select id="selectTop4PetsForCard"
        parameterType="long" resultType="edu.example.bughunters.domain.AbandonedPetDTO">
	  SELECT
	    ap.abandoned_pet_id,
	    ap.kind,
	    ap.age,
	    ap.weight,
	    ap.address,
	    ap.description,
	    ap.profile_image,
	    ap.gender
	  FROM Matching_User_Top_Pets mup
	  JOIN Abandoned_Pet ap
	    ON ap.abandoned_pet_id = mup.abandoned_pet_id
	  WHERE mup.user_id = #{userId}
	  ORDER BY mup.rank_no
	  FETCH FIRST 4 ROWS ONLY
	</select>

	<!-- 로그인한 사용자 이름으로 is_quiz 조회 -->
	<select id="selectIsQuizByUsername" parameterType="string"
		resultType="int">
		SELECT is_quiz
		FROM Member
		WHERE username = #{username}
	</select>


</mapper>
